<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web Streams</title>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section>
          <h1>
            <span class="r-fit-text">Web Streams</span>
            <br />
            <span class="r-fit-text">From source to sink</span>
          </h1>
          <h3>Mattias Buelens</h3>
        </section>
        <section>
          <section>
            <h1>What's the Streams API?</h1>
          </section>
          <section>
            <blockquote>
              <p>
                &laquo; The Streams API allows JavaScript to programmatically
                access streams of data received over the network and process
                them as desired by the developer. &raquo;
              </p>
              <cite
                ><a
                  href="https://developer.mozilla.org/en-US/docs/Web/API/Streams_API"
                  >Streams API, MDN</a
                ></cite
              >
            </blockquote>
          </section>
          <section>
            <h1>What's a stream?</h1>
          </section>
          <section data-auto-animate>
            <h2>A stream is an...</h2>
            <ul class="stretch">
              <li>
                ordered
                <ul class="fragment current-appear">
                  <li>process <em>N</em>th item before <em>N+1</em>th item</li>
                </ul>
              </li>
              <li>
                possibly asynchronous
                <ul class="fragment current-appear">
                  <li>next item might not be available immediately</li>
                  <li>
                    need to <code class="language-js">await</code> a
                    <code class="language-ts">Promise</code>
                  </li>
                </ul>
              </li>
              <li>
                data flow whose chunks
                <ul class="fragment current-appear">
                  <li>chunk = single bit of data</li>
                  <li>
                    can be anything: <code class="language-ts">string</code>,
                    <code class="language-ts">number</code>,&hellip;
                  </li>
                  <li>
                    byte streams: chunk =
                    <code class="language-ts">Uint8Array</code>
                  </li>
                </ul>
              </li>
              <li>
                can be read, processed or written
                <ul class="fragment current-appear">
                  <li>
                    different kinds of streams for producers, transformers and
                    consumers
                  </li>
                </ul>
              </li>
              <li>
                in an incremental fashion
                <ul class="fragment current-appear">
                  <li>can start processing before all data is available</li>
                  <li>don't have to buffer all data into memory</li>
                </ul>
              </li>
            </ul>
          </section>
        </section>
        <section>
          <section><h1>Readable streams</h1></section>
          <section>
            <h2><code class="language-js">ReadableStream</code></h2>
            <ul>
              <li>
                a <em>source</em> of data from which you can
                <em>read</em> chunks
              </li>
              <li>
                can be read by a single consumer at a time, using a "reader"
              </li>
            </ul>
            <pre><code class="language-js" data-trim data-line-numbers data-noescape>
              const readable = new ReadableStream(/* ignore for now */);
              const reader = reader.getReader();
              while (true) {
                // get the next chunk, waiting for it if necessary
                const { done, value } = await reader.read();
                if (done) {
                  // no more chunks, end of stream
                  break;
                }
                // got a chunk!
                console.log(`received chunk: ${value}`);
              }
            </code></pre>
          </section>
          <section>
            <h2>Example: streaming <code class="language-js">fetch()</code></h2>
            <pre><code class="language-js" data-trim data-line-numbers data-noescape>
              // reading HTTP response without streaming
              const response = await fetch("https://example.com");
              const bytes = await response.arrayBuffer();
              console.log(`received ${bytes.byteLength} total bytes`);

              // reading HTTP response with streaming
              const response = await fetch("https://example.com");
              const body = response.body;       // ReadableStream&lt;Uint8Array&gt;
              const reader = body.getReader();  // ReadableStreamDefaultReader
              while (true) {
                const { done, value } = await reader.read();
                if (done) break; // reached end of stream
                console.log(`received chunk with ${value.byteLength} bytes`);
              }
            </code></pre>
          </section>
          <section data-auto-animate>
            <h2>Creating a <code class="language-js">ReadableStream</code></h2>
            <ul>
              <li>
                not all streams have to come from
                <code class="language-js">fetch()</code>
              </li>
              <li>make your own!</li>
            </ul>
            <pre
              data-id="code"
            ><code class="language-js" data-trim data-line-numbers data-noescape>
              const readable = new ReadableStream({
                start(controller) {
                  // called immediately during construction
                  // for setup: open connections, add listeners,...
                },
                pull(controller) {
                  // called when more data is needed
                },
                cancel(reason) {
                  // called when consumer is no longer interested
                  // for cleanup: close connection, remove listeners,...
                }
              })
            </code></pre>
          </section>
          <section data-auto-animate>
            <h2>Creating a <code class="language-js">ReadableStream</code></h2>
            <ul>
              <li>use the given controller to update the stream</li>
            </ul>
            <pre
              data-id="code"
            ><code class="language-js" data-trim data-line-numbers data-noescape>
              const readable = new ReadableStream({
                pull(controller) {
                  // to push a chunk onto the stream:
                  controller.enqueue("some data");
                  // to close the stream normally (i.e. reached end of file)
                  controller.close();
                  // to close the stream abnormally (i.e. I/O error)
                  controller.error(new Error("oh no"));
                }
              })
            </code></pre>
          </section>
          <section>
            <h2>Writable streams</h2>
            <ul>
              <li>
                a <em>destination</em> for data into which you can
                <em>write</em> chunks
              </li>
              <li>e.g.: writing to a file using the File System API</li>
            </ul>
            <pre><code class="language-js" data-trim data-line-numbers data-noescape>
              // example from FileSystemWritableFileStream on MDN
              // open a "Save file" dialog to let the user choose a file
              const newFileHandle = await window.showSaveFilePicker();
              // create a WritableFileStream
              const writable = await newFileHandle.createWritable();
              // write to our new file
              await writable.write("This is my file content");
              // close the file and write the contents to disk
              await writable.close();
            </code></pre>
          </section>
          <section>
            <h2>Streaming across threads</h2>
            <ul>
              <li>
                all streams are transferable, which means you can
                <code class="language-js">postMessage()</code> them to a worker
              </li>
            </ul>
            <pre><code class="language-js" data-trim data-line-numbers data-noescape>
              // page.js
              const worker = new Worker("worker.js");
              const { readable, writable } = new TransformStream();
              worker.postMessage(readable, { transfer: [readable] });
              const writer = writable.getWriter();
              writer.write("Hello world!"); // send to worker's ReadableStream
              writer.close();

              // worker.js
              onmessage = async (event) => {
                const readable = event.data; // transferred ReadableStream
                for await (const chunk of readable) {
                  console.log(chunk); // -> "Hello world!"
                }
              };
            </code></pre>
          </section>
          <section>
            <h2>Streaming across threads</h2>
            <ul>
              <li>move CPU-intensive work to another thread</li>
            </ul>
            <pre><code class="language-js" data-trim data-line-numbers data-noescape>
              // page.js
              const worker = new Worker("worker.js");
              worker.onmessage = async (event) => {
                const transform = event.data; // transferred TransformStream
                const input = (await fetch("https://example.com")).body;
                const output = input.pipeThrough(transform);
                for await (const chunk of output) { console.log(chunk); }
              };
              // worker.js
              const transform = new TransformStream({
                transform(chunk, controller) {
                  controller.enqueue(doExpensiveTransform(chunk));
                }
              });
              self.postMessage(transform, { transfer: [transform] });
            </code></pre>
          </section>
        </section>
        <section data-visibility="hidden">
          <!-- TODO What to do with this section? -->
          <section>
            <h2>Kinds of values</h2>
            <table class="stretch">
              <thead>
                <tr>
                  <th></th>
                  <th>Single value</th>
                  <th>Multiple values</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <th>Sync</th>
                  <td>
                    <code class="language-ts">T</code>
                  </td>
                  <td>
                    <code class="language-ts" data-noescape
                      >Iterable&lt;T&gt;</code
                    ><br />
                    e.g.
                    <code class="language-ts" data-noescape>Array&lt;T&gt;</code
                    >,
                    <code class="language-ts" data-noescape>Set&lt;T&gt;</code>
                  </td>
                </tr>
                <tr>
                  <th>Async</th>
                  <td>
                    <code class="language-ts" data-noescape
                      >Promise&lt;T&gt;</code
                    >
                  </td>
                  <td>
                    <code class="language-ts" data-noescape
                      >AsyncIterable&lt;T&gt;</code
                    ><br />
                    e.g.
                    <code class="language-ts" data-noescape
                      >ReadableStream&lt;T&gt;</code
                    >
                  </td>
                </tr>
              </tbody>
            </table>
          </section>
          <section data-auto-animate>
            <h2 data-id="title">Single value / synchronous</h2>
            <pre
              data-id="code"
            ><code class="language-js" data-trim data-line-numbers data-noescape>
              const value = getThing();
              doSomething(value);
            </code></pre>
            <p>Examples:</p>
            <ul>
              <li>
                Your name as a
                <code class="language-ts">string</code>
              </li>
              <li>
                A random
                <code class="language-ts">number</code> from
                <code class="language-js">Math.random()</code>
              </li>
            </ul>
          </section>
          <section data-auto-animate>
            <h2 data-id="title">Single value / asynchronous</h2>
            <pre
              data-id="code"
            ><code class="language-js" data-trim data-line-numbers data-noescape>
              const value = await getThing();
              doSomething(value);
            </code></pre>
            <p>Examples:</p>
            <ul>
              <li>
                The response text from a
                <code class="language-js">fetch()</code>ed
                <code class="language-js">Response.text()</code>
                as a
                <code class="language-ts" data-noescape
                  >Promise&lt;string&gt;</code
                >
              </li>
            </ul>
          </section>
          <section data-auto-animate data-auto-animate-restart>
            <h2 data-id="title">Multiple values / synchronous</h2>
            <pre
              data-id="code"
            ><code class="language-js" data-trim data-line-numbers data-noescape>
              for (const value of getThings()) {
                doSomething(value);
              }
            </code></pre>
            <p>Examples:</p>
            <ul>
              <li>
                Your favorite colors as an
                <code class="language-ts" data-noescape
                  >Array&lt;string&gt;</code
                >
              </li>
              <li>
                The <code class="language-js">keys()</code> from a
                <code class="language-ts">Map</code> as an
                <code class="language-ts" data-noescape
                  >Iterator&lt;TKey&gt;</code
                >
              </li>
              <li>
                A
                <code class="language-ts" data-noescape
                  >NodeList&lt;HTMLElement&gt;</code
                >
                from
                <code class="language-js">document.querySelectorAll()</code>
              </li>
            </ul>
          </section>
          <section data-auto-animate>
            <h2 data-id="title">Multiple values / asynchronous</h2>
            <pre
              data-id="code"
            ><code class="language-js" data-trim data-line-numbers data-noescape>
              for await (const value of getThings()) {
                doSomething(value);
              }
            </code></pre>
            <p>Examples:</p>
            <ul>
              <li>
                The messages in a group chat as a
                <code class="language-ts" data-noescape
                  >ReadableStream&lt;string&gt;</code
                >
              </li>
              <li>
                The stream of byte chunks from a
                <code class="language-js">fetch()</code>ed
                <code class="language-js">Response.body</code>
                as a
                <code class="language-ts" data-noescape
                  >ReadableStream&lt;Uint8Array&gt;</code
                >
              </li>
            </ul>
          </section>
        </section>
      </div>
    </div>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
